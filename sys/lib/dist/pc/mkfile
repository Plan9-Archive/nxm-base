MKSHELL=rc

$NXM/sys/src/9/pc/9pccd.gz:
	@{
		cd $NXM/sys/src/9/pc
		mk 'CONF=pccd' 9pccd.gz
	}

# disk/format apparently uses stat to obtain a file's real name, so
# binding 9loadusb onto 9load will store the name 9loadusb in the
# generated fat filesystem.  the same is true for plan9.ini.cd and plan9.ini.

9load: $NXM/386/9loadlite
	cp $prereq $target
#	if (test -e $NXM/386/9loadnousb)
#		cp  $NXM/386/9loadnousb $target	# cater to old bioses
	cp $NXM/386/9loadlitedebug 9loaddebug

# cannot list both 9pcflop.gz and 9pccd.gz because they cannot be built 
# in parallel.  stupid mk
#cddisk:DV: 9load $NXM/sys/src/9/pc/9pccd.gz plan9.ini.cd $NXM/lib/vgadb
cddisk:DV: 9load $NXM/sys/src/nxm/k10/9k8cpuserial.gz plan9.ini.cd $NXM/lib/vgadb
#	mk -a $NXM/sys/src/9/pc/9pccd.gz
#	mk -a /sys/src/9/pc/9pcflop.gz
	rfork n
	cp -x plan9.ini.cd subst/plan9.ini
	cp $NXM/sys/src/nxm/k10/9k8cpuserial.gz /tmp/9k8.gz
	dd -if /dev/zero -of cddisk -bs 1024 -count 2880 >[2]/dev/null
#	disk/format -t 3½QD -f -b $NXM/386/pbs -d cddisk \
#		9load $NXM/sys/src/9/pc/9pccd.gz \
	/home/john/base/sys/src/cmd/disk/format -t 3½QD -f -b $NXM/386/pbs -d cddisk \
		9load /tmp/9k8.gz \
		subst/plan9.ini $NXM/lib/vgadb
	ls -l cddisk

clean:V:
	if (! unmount 9load >[2]/dev/null)
		;
	rm -rf boot boot.bz2 boot.bflz boot.raw root.bz2 9pcflop 9load cddisk proto.cp 9loaddebug

cd0:D:	cddisk
	rm -f cd0
	disk/mk9660 -9cj -v 'Plan 9 4th Edition' -s . -p cd0.proto -b cddisk cd0
